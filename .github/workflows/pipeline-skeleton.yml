name: CI/CD Pipeline (Skeleton Example)

# This is an EXAMPLE of how to consume the reusable CI/CD platform workflow.
# Application teams should copy this pattern to their repositories.
#
# The actual pipeline logic lives in .github/workflows/reusable/cicd-platform.yml
# This file is intentionally thin - it only passes inputs to the platform.

on:
  push:
    branches:
      - main
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

jobs:
  # ===========================================================================
  # CONSUME THE REUSABLE PLATFORM WORKFLOW
  # ===========================================================================
  platform-cicd:
    name: Platform CI/CD
    
    # Required: OIDC permissions for Azure authentication
    # The reusable workflow needs to request OIDC tokens for Azure login
    permissions:
      id-token: write   # Required for OIDC authentication to Azure
      contents: read    # Required to checkout code
    
    uses: ./.github/workflows/cicd-platform.yml
    with:
      # Required: Name of the service
      service_name: "api-gateway"
      
      # Optional: Environment routing (default: auto)
      # "auto" = platform determines from branch
      # Or explicitly set: development, staging, production
      environment: ${{ github.event.inputs.environment || 'auto' }}
      
      # Optional: Artifact type (default: container-image)
      artifact_type: "container-image"
      
      # Optional: Enable deployment stages (default: true)
      deploy_enabled: true
      
      # Optional: Run tests (default: true)
      run_tests: true
      
      # Optional: Run security scan (default: true)
      run_security_scan: true
    
    # Pass secrets to reusable workflow (required for Azure OIDC)
    secrets: inherit

# ===========================================================================
# WHAT HAPPENS AUTOMATICALLY
# ===========================================================================
# The platform workflow enforces:
# ✅ Branch validation (only allowed patterns)
# ✅ Artifact immutability (no mutable tags like 'latest')
# ✅ Promotion gates (staging before production)
# ✅ Security scanning (blocks on critical CVEs)
# ✅ OIDC authentication (no static credentials)
# ✅ Observability (metrics, logs, audit artifacts)
#
# Application teams cannot bypass these enforcements.

# ===========================================================================
# WHAT APPLICATION TEAMS PROVIDE
# ===========================================================================
# App teams are responsible for:
# ❌ Build commands (how to build the service)
# ❌ Test commands (how to run tests)
# ❌ Deployment manifests (Kubernetes/Helm configuration)
# ❌ Service-specific config (environment variables, scaling)
#
# Platform handles: enforcement, orchestration, observability

# ===========================================================================
# EXAMPLE USAGE PATTERNS
# ===========================================================================
# 
# 1. Feature branch push:
#    - Triggers: on.push for feature/** branches
#    - Behavior: Build → Test → Scan → Deploy to development
#
# 2. Main branch push:
#    - Triggers: on.push for main branch
#    - Behavior: Build → Test → Scan → Deploy to staging
#
# 3. Production deployment:
#    - Triggers: workflow_dispatch with environment=production
#    - Behavior: Validates staging passed → Manual approval → Deploy to production
#
# 4. Pull request:
#    - Triggers: on.pull_request
#    - Behavior: Build → Test → Scan (no deployment)

# ===========================================================================
# MIGRATION FROM OLD PIPELINES
# ===========================================================================
# Before (copy-pasted 1400 lines of YAML):
#   - Hard to maintain
#   - Enforcement can be bypassed
#   - No automatic updates
#
# After (this file, ~100 lines):
#   - Platform updates flow automatically
#   - Enforcement cannot be bypassed
#   - Consistent across all services
#
# To migrate:
#   1. Replace your .github/workflows/cicd.yml with this template
#   2. Update service_name to match your service
#   3. Customize inputs if needed (most defaults are fine)
#   4. Delete old pipeline logic (it's now in the reusable workflow)

# ===========================================================================
# DOCUMENTATION
# ===========================================================================
# See: .github/workflows/reusable/README.md for:
#   - Input descriptions
#   - Enforcement details
#   - Troubleshooting
#   - Advanced customization
